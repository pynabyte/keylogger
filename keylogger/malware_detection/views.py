from rest_framework.views import APIView
from rest_framework.response import Response as R
from rest_framework import status as s
from rest_framework.permissions import IsAuthenticated
from malware_detection.models import MalwareFiles
from django.conf import settings
from malware_detection.utils import analyze_metrics,checkFile

class MalwareDetectionView(APIView):
    permission_classes = [IsAuthenticated,]
    def post(self,request,format=None):
        file = request.data.get("file")
        if not file:
            return R({"error":"Please select a file"},s.HTTP_400_BAD_REQUEST)

        malware_file = MalwareFiles.objects.create(file=file,user=request.user)
        path = rf"{str(settings.BASE_DIR) + malware_file.file.url}"
        metric = analyze_metrics(path=path)
        result = checkFile(file_path=path,base_directory=settings.BASE_DIR)
        metric.update(result)
        legitimate = metric.pop("legitimate")
        return R({"metric":metric,"legitimate":legitimate},s.HTTP_201_CREATED)